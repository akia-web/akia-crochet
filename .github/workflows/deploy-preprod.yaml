name: Deploy Preprod

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupérer l'asset
      - name: Get asset
        id: get_asset
        uses: actions/github-script@v6
        with:
          script: |
            const tag = '${{ github.event.inputs.tag }}';
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag
            });

            const asset = release.data.assets.find(a => a.name.endsWith('.zip'));
            if (!asset) throw new Error(`No zip found for ${tag}`);

            return JSON.stringify({
              assetUrl: asset.browser_download_url,
              assetName: asset.name
            });

      # 2️⃣ Télécharger sur le runner
      - name: Download zip
        run: |
          ASSET_NAME=$(echo '${{ steps.get_asset.outputs.result }}' | jq -r '. | fromjson | .assetName')
          ASSET_URL=$(echo '${{ steps.get_asset.outputs.result }}' | jq -r '. | fromjson | .assetUrl')

          curl -L -o "$ASSET_NAME" "$ASSET_URL"
          echo "ZIP_NAME=$ASSET_NAME" >> $GITHUB_ENV

      # 3️⃣ Envoyer le zip au serveur
      - name: Copy zip to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "${{ env.ZIP_NAME }}"
          target: "/var/www/html/akialoops-preprod"

      # 4️⃣ Déployer sur le serveur
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          envs: ZIP_NAME
          script: |
            DEPLOY_PATH=/var/www/html/akialoops-preprod
            cd $DEPLOY_PATH

            echo "Current directory:"
            pwd

            echo "Files in directory:"
            ls -la
            
            echo "ZIP_NAME = $ZIP_NAME"
  
            if [ -d "dist" ]; then
              mv dist dist_backup_$(date +%Y%m%d%H%M%S)
            fi

            rm -rf dist
            mkdir dist
            unzip -o "/var/www/html/akialoops-preprod/$ZIP_NAME" -d dist