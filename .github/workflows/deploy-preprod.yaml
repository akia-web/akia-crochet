name: Deploy Preprod from Tag

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag à déployer'
        required: true
        default: ''  # laisse vide pour forcer la sélection depuis l'interface

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupère le tag choisi via l'interface
      - name: Set tag
        run: |
          echo "TAG_TO_DEPLOY=${{ github.event.inputs.tag }}" >> $GITHUB_ENV

      # 2️⃣ Récupère la release correspondante
      - name: Get release for tag
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const tag = process.env.TAG_TO_DEPLOY;
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag
            });

            // Cherche le zip associé
            const asset = release.data.assets.find(a => a.name.endsWith('.zip'));
            if (!asset) throw new Error(`Aucun zip trouvé pour le tag ${tag}`);

            return JSON.stringify({ assetUrl: asset.browser_download_url, assetName: asset.name });

      # 3️⃣ Télécharge le zip
      - name: Download release zip
        run: |
          ASSET_INFO=$(echo ${{ steps.get_release.outputs.result }} | jq -r '.assetName')
          ASSET_URL=$(echo ${{ steps.get_release.outputs.result }} | jq -r '.assetUrl')
          echo "Downloading $ASSET_INFO from $ASSET_URL"
          curl -L -o "$ASSET_INFO" "$ASSET_URL"

      # 4️⃣ Upload et déploiement sur serveur
      - name: Deploy on server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            DEPLOY_PATH=/var/www/html/akialoops-preprod
            cd $DEPLOY_PATH

            ZIP_NAME=$(ls dist-*.zip | sort -V | tail -n1)

            if [ -d "dist" ]; then
              mv dist dist_backup_$(date +%Y%m%d%H%M%S)
              rm -rf dist
            fi

            mkdir dist
            unzip -o $ZIP_NAME -d dist